const config={gravityEnabled:!0,gravity:.1,jumpHeight:2,defaultPlayerSpeed:7,playerMaxSpeedError:20,playerMaxSpeed:1,scrollDistance:300,borderThickness:300,defaultAnimationRunDelay:1,defWidth:2880,defHeight:1620,frameRate:60};let debugMode=!1,editorPrecision=35,editorMode=!1,startBox={x:0,y:0},endBox={x:0,y:0},boxHolder=[],typeOfEntity="solid",map={},spriteSheets={},animationRunDelay=config.defaultAnimationRunDelay,animationRunDelayCounter=0,playerDirection="right",objects={player:null,origin:null,bounds:null,backgroundImg:null,img:[],solids:[],ladders:[],stairs:[],frozen:[],nonFrozen:[],borders:[],tokens:[],traps:[],grids:[],boxHolder:[],background:[]};const objectsInit=objects;var scrollOffsetAdjustment={x:0,y:0},scrollOffsetTotal={x:0,y:0};let lastMove=[],lastPos=[],respawning=!1,wallJumpAllowed=!1,playerMovementCheck=!0,wallJumpTimer=null,stairScroll=!1,detectOutOfBoundsToggle=!0,backgroundMusicPlaying=!1,score=0,secondsPassed=0,oldTimeStamp=0,totalFrames=0;const noop=()=>{};Number.prototype.round=(num,roundUp=!1)=>roundUp?Math.ceil(this/num)*num:Math.round(this/num)*num,Object.prototype.getKeysByValue=selection=>Object.keys(Object.fromEntries(Object.entries(this).filter(element=>element[1][0]==selection))),Array.prototype.filterArray=value=>this.filter((function(ele){return ele!=value})),Array.prototype.removeArray=what=>{const index=this.indexOf(what);index>-1&&this.splice(index,1)},Object.prototype.removeDict=what=>{let keyList=Object.keys(this);this==objects&&(keyList.removeArray("player"),keyList.removeArray("origin"),keyList.removeArray("bounds"),keyList.removeArray("backgroundImg"));for(let i=0;i<keyList.length;i++)this[keyList[i]].removeArray(what)};const updateClipboard=newClip=>{navigator.clipboard.writeText(newClip).then((function(){}),(function(){}))},returnMoveValues=entity=>({x:entity.moveValues.x,y:entity.moveValues.y,amount:entity.moveValues.amount,totMovX:entity.moveValues.x*entity.moveValues.amount,totMovY:entity.moveValues.y*entity.moveValues.amount,newx:entity.posx+entity.moveValues.x*entity.moveValues.amount,newy:entity.posy+entity.moveValues.y*entity.moveValues.amount}),lerp=(start,end,speed)=>start+(end-start)*speed,oscillator=(time,frequency=1,amplitude=1,phase=0,offset=0)=>Math.sin(time*frequency*Math.PI*2+phase*Math.PI*2)*amplitude+offset,getRandom=(min,max)=>(min=Math.ceil(min),max=Math.floor(max),Math.random()*(max-min)+min),canvas=document.getElementById("game-canvas"),ctx=canvas.getContext("2d");function getMousePosition(canvas,start,event){const x=(event.clientX*canvas.width/canvas.clientWidth-objects.origin.posx).round(editorPrecision),y=((innerHeight-event.clientY)*canvas.height/canvas.clientHeight-objects.origin.posy).round(editorPrecision);if(console.log("Coordinate x: "+x,"Coordinate y: "+y),start)startBox.x=x,startBox.y=y;else if(endBox.x=x,endBox.y=y,editorMode){if(0==Math.abs(endBox.x-startBox.x).round(editorPrecision)||0==Math.abs(endBox.y-startBox.y).round(editorPrecision))throw"Error: box must be at least 1 unit in size";var boxTemp={width:Math.abs(endBox.x-startBox.x).round(editorPrecision),height:Math.abs(endBox.y-startBox.y).round(editorPrecision),initPosx:Math.min(startBox.x,endBox.x).round(editorPrecision),initPosy:Math.min(startBox.y,endBox.y).round(editorPrecision),styles:[],types:[]};switch(typeOfEntity){case"solid":boxTemp.styles=["img","solid_brick","idle"],boxTemp.types=["solid"];break;case"ladder":boxTemp.styles=["draw","#2370db"],boxTemp.types=["ladder"];break;case"trap":boxTemp.styles=["img","trap","idle"],boxTemp.types=["trap"];break;case"token":boxTemp.styles=["draw","#42f5a1"],boxTemp.types=["token"];break;case"stair":return void drawStairs(startBox.x+objects.origin.posx,startBox.y+objects.origin.posy,endBox.x+objects.origin.posx,endBox.y+objects.origin.posy,"#f2f5a1");case"background":boxTemp.styles=["draw","#2dff"],boxTemp.types=["background"];default:console.log("Error: entity type not found")}boxHolder.push(boxTemp),objects.boxHolder.push(new entity(boxHolder.at(-1).width,boxHolder.at(-1).height,boxHolder.at(-1).initPosx+objects.origin.posx,boxHolder.at(-1).initPosy+objects.origin.posy,boxHolder.at(-1).styles,boxHolder.at(-1).types)),updateClipboard(JSON.stringify(boxHolder))}}window.addEventListener("resize",()=>{let canvasScale=Math.min(innerWidth/config.defWidth,innerHeight/config.defHeight);canvas.style.width=(canvas.width=Math.floor(config.defWidth*canvasScale))+"px",canvas.style.height=(canvas.height=Math.floor(config.defHeight*canvasScale))+"px",canvas.width=config.defWidth>innerWidth?config.defWidth:innerWidth,canvas.height=config.defHeight>innerHeight?config.defHeight:innerHeight,ctx.translate(0,canvas.height),ctx.scale(1,-1),0!=objects.borders.length&&(objects.borders.forEach(border=>{objects.borders=objects.borders.filterArray(border),objects.frozen=objects.frozen.filterArray(border),objects.solids=objects.solids.filterArray(border)}),makeDefaultEntities(!0))}),$.getJSON({async:!1,url:"/assets/json/map.json",success:data=>{map=data},error:function(data,jqXHR,textStatus,errorThrown){console.log(jqXHR),console.log(textStatus),console.log(errorThrown)}}),$.getJSON({async:!1,url:"/assets/json/sprite-sheet.json",success:function(data){spriteSheets=data}}),window.addEventListener("DOMContentLoaded",(function(){window.dispatchEvent(new Event("resize")),startUp()})),window.addEventListener("keydown",onKeyDown,!1),window.addEventListener("keyup",onKeyUp,!1),soundManager.setup({debugMode:!1}),soundManager.defaultOptions={autoLoad:!0},soundManager.onready((function(){soundManager.createSound({id:"backgroundMusic",url:"/assets/sound/CHIPTUNE_The_Old_Tower_Inn.mp3",onfinish:function(){playSound("backgroundMusic1")},volume:70}),soundManager.createSound({id:"backgroundMusic1",url:"/assets/sound/CHIPTUNE_Minstrel_Dance.mp3",onfinish:function(){setTimeout(()=>{playSound("backgroundMusic2")},2e3)},volume:70}),soundManager.createSound({id:"backgroundMusic2",url:"/assets/sound/CHIPTUNE_The_Bards_Tale.mp3",onfinish:function(){setTimeout(()=>{playSound("backgroundMusic")},2e3)},volume:70}),soundManager.createSound({id:"trombone",url:"/assets/sound/FX68GWY-funny-trombone-slide-accent.mp3",autoLoad:!1}),soundManager.createSound({id:"pickUp",url:"/assets/sound/mixkit-arcade-mechanical-bling-210.wav",volume:50}),soundManager.createSound({id:"jump",url:"/assets/sound/mixkit-player-jumping-in-a-video-game-2043.wav",volume:30}),soundManager.createSound({id:"wallJump",url:"/assets/sound/mixkit-video-game-spin-jump-2648.wav",volume:50,autoLoad:!1}),soundManager.createSound({id:"death",url:"/assets/sound/163442__under7dude__man-dying.wav",volume:100})})),canvas.addEventListener("mousedown",(function(e){getMousePosition(canvas,!0,e)})),canvas.addEventListener("mouseup",(function(e){getMousePosition(canvas,!1,e)}));class entity{constructor(width,height,initPosx,initPosy,styles=["draw","#ff2f34"],types=["solid"]){switch(ctx.fillRect(0,0,canvas.width,canvas.height,"black"),this.width=width,this.height=height,this.initWidth=width,this.initHeight=height,this.posx=initPosx,this.posy=initPosy,this.types=types,this.totalTimePassed=0,this.mainType=types[0],this.moveValues={x:0,y:0,amount:0,speed:7},styles[0]){case"img":this.style="img",objects.img.push(this),this.imgLink=styles[1],this.img=new Image,this.img.src=spriteSheets[styles[1]].img,this.animation=styles[2],this.sx=spriteSheets[styles[1]][this.animation].sx,this.sy=spriteSheets[styles[1]][this.animation].sy,this.sWidth=spriteSheets[styles[1]][this.animation].sWidth,this.sHeight=spriteSheets[styles[1]][this.animation].sHeight,"player"!=this.mainType&&finalizeGroundEntities(this),this.draw=()=>{this.drawImg(this)};break;case"draw":this.style="draw",this.color=styles[1],this.draw=()=>{this.drawRect(this)};break;case"grid":this.style="grid",this.color=styles[1];break;default:console.log("Error: entity style not found (setup)")}if(types.indexOf("player")>-1)return this.crouched=!1,this.touchedGround=!1,this.touchedLadder=!1,this.lastPos=[void 0,void 0],this.lastMove=[void 0,void 0],void(this.move=()=>{this.movePlayer(this)});types.indexOf("backgroundImg")>-1&&(this.animationSpeed=getRandom(20,35),objects.backgroundImg=this),types.indexOf("solid")>-1&&objects.solids.push(this),types.indexOf("ladder")>-1&&objects.ladders.push(this),types.indexOf("frozen")>-1?objects.frozen.push(this):objects.nonFrozen.push(this),types.indexOf("stair")>-1&&objects.stairs.push(this),types.indexOf("border")>-1&&objects.borders.push(this),types.indexOf("token")>-1&&objects.tokens.push(this),types.indexOf("grid")>-1&&objects.grids.push(this),types.indexOf("trap")>-1&&(this.animationSpeed=getRandom(20,35),objects.traps.push(this)),types.indexOf("background")>-1&&objects.background.push(this),this.move=()=>{this.moveDefault(this)}}drawImg=()=>{ctx.drawImage(this.img,this.sx,this.sy,this.sWidth,this.sHeight,this.posx,this.posy,this.width,this.height)};drawRect=()=>{ctx.beginPath(),ctx.fillStyle=this.color,ctx.fillRect(this.posx,this.posy,this.width,this.height),ctx.closePath()};drawGrid=()=>{ctx.beginPath(),ctx.strokeStyle=this.color,ctx.lineWidth=3,ctx.rect(this.posx,this.posy,this.width,this.height),ctx.stroke(),ctx.closePath()};movePlayer=()=>{config.gravityEnabled?playerMovementGravity(this,secondsPassed):playerMovementNoGravity(this,secondsPassed),0!=this.moveValues.amount&&(this.posx+=this.moveValues.x*this.moveValues.amount,this.posy+=this.moveValues.y*this.moveValues.amount)};moveDefault=()=>{0==scrollOffsetAdjustment.x&&0==scrollOffsetAdjustment.y||(this.posx+=scrollOffsetAdjustment.x,this.posy+=scrollOffsetAdjustment.y)}}var keys={dKey:[!1,!1],aKey:[!1,!1],sKey:[!1],spaceKey:[!1],shiftKey:[!1],wKey:[!1],xKey:[!1],zKey:[!1],ctrlKey:[!1],enterKey:[!1],oneKey:[!1],twoKey:[!1],threeKey:[!1],fourKey:[!1],fiveKey:[!1],sixKey:[!1]};function onKeyDown(event){let keyCode;switch(event.keyCode){case 68:if(keys.dKey[1])break;if(keys.dKey[0]=!0,keys.dKey[1]=!0,!backgroundMusicPlaying){let startSong=Math.floor(3*Math.random());0==startSong?playSound("backgroundMusic"):1==startSong?playSound("backgroundMusic1"):2==startSong&&playSound("backgroundMusic2"),backgroundMusicPlaying=!0}break;case 83:keys.sKey[0]=!0;break;case 65:if(keys.aKey[1])break;keys.aKey[0]=!0,keys.aKey[1]=!0;break;case 87:keys.wKey[0]=!0;break;case 13:keys.enterKey[0]=!0,editorMode=!editorMode,editorMode||(updateClipboard(JSON.stringify(boxHolder)),console.log(JSON.stringify(boxHolder))),alert(editorMode?"Editor Mode is: on":"Editor Mode is: off");break;case 32:keys.spaceKey[0]=!0;break;case 16:debugMode=!debugMode,window.dispatchEvent(new Event("resize")),keys.shiftKey[0]=!0;break;case 90:keys.zKey[0]=!0;let length=boxHolder.length;if(editorMode&&length>0){let tempBox=objects.boxHolder[length-1];if(keys.ctrlKey[0])if(tempBox.types.indexOf("stairLast")>-1){for(;!(objects.boxHolder[objects.boxHolder.length-1].types.indexOf("stairFirst")>-1);)tempBox=objects.boxHolder[objects.boxHolder.length-1],objects.removeDict(tempBox),boxHolder.pop();tempBox=objects.boxHolder[objects.boxHolder.length-1],objects.removeDict(tempBox),boxHolder.pop(),updateClipboard(JSON.stringify(boxHolder))}else objects.removeDict(tempBox),boxHolder.pop(),updateClipboard(JSON.stringify(boxHolder))}break;case 17:keys.ctrlKey[0]=!0;break;case 221:editorMode&&(editorPrecision+=5,debugMode&&drawGrid(editorPrecision));break;case 219:editorMode&&editorPrecision>5&&(editorPrecision-=5,debugMode&&drawGrid(editorPrecision));break;case 49:keys.oneKey[0]=!0,typeOfEntity="ladder";break;case 50:keys.twoKey[0]=!0,typeOfEntity="trap";break;case 51:keys.threeKey[0]=!0,typeOfEntity="token";break;case 52:keys.fourKey[0]=!0,typeOfEntity="solid";break;case 53:keys.fiveKey[0]=!0,typeOfEntity="stair";break;case 54:keys.sixKey[0]=!0,typeOfEntity="background"}}function onKeyUp(event){let keyCode;switch(event.keyCode){case 68:keys.dKey[0]=!1,keys.dKey[1]=!1;break;case 83:keys.sKey[0]=!1;break;case 65:keys.aKey[0]=!1,keys.aKey[1]=!1;break;case 87:keys.wKey[0]=!1;break;case 13:keys.enterKey[0]=!1;break;case 32:keys.spaceKey[0]=!1;break;case 16:keys.shiftKey[0]=!1;break;case 90:keys.zKey[0]=!1;break;case 88:keys.xKey[0]=!1;break;case 17:keys.ctrlKey[0]=!1;break;case 49:keys.oneKey[0]=!1;break;case 50:keys.twoKey[0]=!1;break;case 51:keys.threeKey[0]=!1;break;case 52:keys.fourKey[0]=!1;break;case 53:keys.fiveKey[0]=!1;break;case 54:keys.sixKey[0]=!1}}const drawStairs=function(x1,y1,x2,y2,color){console.log("drawStairs");const slope=(y2-y1)/(x2-x1),w=Math.abs(x2-x1),xDir=x2-x1>0?1:-1;let j=0;for(let i=0;i<w;i++){let x=x1+i*xDir,y=y1+j*xDir;boxHolder.push({width:10,height:10,initPosx:x-objects.origin.posx,initPosy:y-objects.origin.posy,styles:["draw",color],types:["solid","stair"]}),objects.boxHolder.push(new entity(10,10,x,y,["draw",color],["solid","stair",0==i?"stairFirst":i==w-1?"stairLast":null])),j+=slope}updateClipboard(JSON.stringify(boxHolder))};function animateRunner(){if(secondsPassed=totalFrames/config.fps,animationRunDelayCounter<=animationRunDelay?animationRunDelayCounter++:animationRunDelayCounter=0,animationRunDelayCounter==animationRunDelay)for(let i=0;i<objects.img.length;i++)animate(objects.img[i],secondsPassed)}function frameUpdate(){for(let i=0;i<objects.frozen.length;i++)objects.frozen[i].draw();for(let i=0;i<objects.nonFrozen.length;i++)objects.nonFrozen[i].move(),objects.nonFrozen[i].draw();scoreUpdate(-1)}function respawn(){detectOutOfBoundsToggle=!1,objects.removeDict(objects.player),objects.player=null;const newScrollOffset_x=scrollOffsetTotal.x,newScrollOffset_y=scrollOffsetTotal.y;scrollOffsetAdjustment.x=-newScrollOffset_x,scrollOffsetAdjustment.y=261.80000000000007-newScrollOffset_y,scrollOffsetTotal.x=0,scrollOffsetTotal.y=261.80000000000007;for(let i=0;i<objects.nonFrozen.length;i++)objects.nonFrozen[i].move(),objects.nonFrozen[i].draw();for(let i=0;i<objects.frozen.length;i++)objects.frozen[i].draw();scrollOffsetAdjustment.x=0,scrollOffsetAdjustment.y=0,objects.player||setTimeout(()=>{objects.player=new entity(100,200,310,310,["img","player","idleR"],["player"]),detectOutOfBoundsToggle=!0},1e3)}function scoreUpdate(value=0){let gradient=ctx.createLinearGradient(0,0,canvas.width,0);ctx.font="60px Arial",score+=value,score<0&&(score=0);let textWidth=ctx.measureText("Score: "+score.round(1,!0)).width;if(gradient.addColorStop("0","pink"),gradient.addColorStop("0.1","cyan"),gradient.addColorStop("0.5","lightblue"),gradient.addColorStop("1.0","red"),ctx.save(),ctx.scale(1,-1),ctx.beginPath(),ctx.rect(13,-73,textWidth+8,60),ctx.fillStyle="#222222",ctx.fill(),ctx.closePath(),ctx.fillStyle=gradient,ctx.fillText("Score: "+score.round(1,!0),20,-20),editorMode){let editorTextWidth1=ctx.measureText("Editor Mode -- snap (use [ / ]): "+editorPrecision).width,editorText2="Press # to change type -- ";switch(typeOfEntity){case"ladder":editorText2+=" ͇1͇:͇ ͇L͇A͇D͇D͇E͇R͇, 2: TRAP, 3: TOKEN, 4: SOLID, 5: STAIRS, 6: BACKGROUND";break;case"trap":editorText2+="1: LADDER, ͇2͇:͇ ͇T͇R͇A͇P͇, 3: TOKEN, 4: SOLID, 5: STAIRS, 6: BACKGROUND";break;case"token":editorText2+="1: LADDER, 2: TRAP, ͇3͇:͇ ͇T͇O͇K͇E͇N͇, 4: SOLID, 5: STAIRS, 6: BACKGROUND";break;case"solid":editorText2+="1: LADDER, 2: TRAP, 3: TOKEN, ͇4͇:͇ ͇S͇O͇L͇I͇D͇, 5: STAIRS, 6: BACKGROUND";break;case"stair":editorText2+="1: LADDER, 2: TRAP, 3: TOKEN, 4: SOLID, ͇5̳:̳ ̳S̳T̳A̳I̳R̳S̳, 6: BACKGROUND";break;case"background":editorText2+="1: LADDER, 2: TRAP, 3: TOKEN, 4: SOLID, 5: STAIRS, ͇6͇:͇ ͇B͇A͇C͇K͇G͇R͇O̳U̳N̳D͇";break;default:console.log("Error: entity type not found")}let editorTextWidth2=ctx.measureText(editorText2).width,editorTextWidth=Math.max(editorTextWidth1,editorTextWidth2);ctx.beginPath(),ctx.rect(13,-210,editorTextWidth+8,120),ctx.fillStyle="#222222",ctx.fill(),ctx.closePath(),ctx.fillStyle=gradient,ctx.fillText("Editor Mode -- snap (use [ / ]): "+editorPrecision,20,-100),ctx.fillText(editorText2,20,-160)}ctx.restore()}function finalizeGroundEntities(entity){const imgWidth=entity.sWidth,imgHeight=entity.sHeight,posx=entity.posx.round(1,!0),posy=(imgHeight-entity.posy-entity.height).round(1,!0),posxImg=imgWidth-posx>0?posx:posx-imgWidth,posyImg=imgHeight-posy>0?posy:posy-imgHeight;switch(entity.mainType){case"trap":entity.sx=Math.random()*imgWidth,entity.sy=imgHeight-entity.height,entity.sWidth=entity.width,entity.sHeight=entity.height;break;case"solid":entity.sx=Math.random()*imgWidth/4,entity.sy=Math.random()*imgWidth/4,entity.sWidth=entity.width/2,entity.sHeight=entity.height/2;break;case"backgroundImg":entity.sx=0,entity.sy=0,entity.sWidth=imgWidth,entity.sHeight=imgHeight}}function animate(entity,secondsPassed){let frames=spriteSheets[entity.imgLink][entity.animation].frames;switch(entity.mainType){case"trap":let height=spriteSheets[entity.imgLink][entity.animation].sHeight;entity.sx=lerp(0,frames,entity.totalTimePassed/entity.animationSpeed),entity.sy=height-entity.height-5*oscillator(totalTimePassed.total,.2,.5),entity.totalTimePassed/entity.animationSpeed>=1?(entity.sx=lerp(0,frames,0),entity.totalTimePassed=0):entity.totalTimePassed/entity.animationSpeed<=-1&&(entity.sx=lerp(0,frames,0),entity.totalTimePassed=0);break;case"solid":break;case"backgroundImg":entity.totalTimePassed>0?entity.sx=lerp(653,frames,entity.totalTimePassed/entity.animationSpeed):entity.totalTimePassed<0&&(entity.sx=lerp(653,0,Math.abs(entity.totalTimePassed)/entity.animationSpeed)),entity.totalTimePassed/entity.animationSpeed>=1?(entity.sx=lerp(653,frames,0),entity.totalTimePassed=0):entity.totalTimePassed/entity.animationSpeed<=-1&&(entity.sx=lerp(653,0,0),entity.totalTimePassed=0);break;default:entity.sx+=entity.sWidth,entity.sx/entity.sWidth>=frames&&(entity.sx=spriteSheets[entity.imgLink][entity.animation].sx)}}function switchAnimation(entity,animationID,animationSpeed=config.defaultAnimationRunDelay){entity.animation!=animationID&&(animationRunDelay=animationSpeed,entity.animation=animationID,entity.sx=spriteSheets[entity.imgLink][entity.animation].sx,entity.sy=spriteSheets[entity.imgLink][entity.animation].sy,entity.sWidth=spriteSheets[entity.imgLink][entity.animation].sWidth,entity.sHeight=spriteSheets[entity.imgLink][entity.animation].sHeight)}const playerMovementGravity=delta=>{let player=objects.player,pMoveVal=player.moveValues;for(keysDown=keys.getKeysByValue([!0]),keysDown=keysDown.concat(keys.getKeysByValue([!0,!0])),i=0;i<keysDown.length;i++)switch(keysDown[i]){case"dKey":pMoveVal.x+=-pMoveVal.speed*delta;break;case"sKey":player.crouched=!0;break;case"aKey":pMoveVal.x+=pMoveVal.speed*delta;break;case"spaceKey":player.touchedGround&&(player.touchedGround=!1,playSound("jump"),moveValues.y+=config.jumpHeight*delta,wallJump||(wallJumpTimer=setTimeout(()=>{wallJumpAllowed=!0,wallJumpTimer=null},400)))}player.move()},detectOutOfBounds=function(entity){let bounds=objects.bounds;if(!bounds||!detectOutOfBoundsToggle)return"Detect Bounds Did Not Run";const moveValues=returnMoveValues(entity);return moveValues.newx+entity.width>bounds.posx&&moveValues.newx<bounds.posx+bounds.width&&entity.posy+entity.height>bounds.posy&&entity.posy<bounds.posy+bounds.height||entity.posx+entity.width>bounds.posx&&entity.posx<bounds.posx+bounds.width&&moveValues.newy+entity.height>=bounds.posy&&moveValues.newy<=bounds.posy+bounds.height||(console.log("out of bounds"),entity.posx=lastPos[0],entity.posy=lastPos[1],entity.moveValues.x=-lastMove[0],entity.moveValues.y=-lastMove[1],!1)},detectCollision=function(entity,checkArrayName="solids",moveEntity=!0){let checkArray,splitHitBoxOffset=3,collision={ladder:!1,stairLeft:!1,stairRight:!1,stairMove:!1,stairScroll:!1,top:!1,bottom:!1,left:!1,right:!1,borderTop:!1,borderBottom:!1,borderRight:!1,borderLeft:!1};switch(checkArrayName){case"ladders":if(checkArray=objects.ladders,length=length,length<=0)break;for(let i=0;i<checkArray.length;i++){const ladder=checkArray[i];if(!ladder)continue;const moveValues=returnMoveValues(entity);(moveValues.newx+entity.width>ladder.posx&&moveValues.newx<ladder.posx+ladder.width&&entity.posy+entity.height>ladder.posy&&entity.posy<ladder.posy+ladder.height||entity.posx+entity.width>ladder.currentPosx&&entity.posx<ladder.currentPosx+ladder.width&&moveValues.newy+entity.height>=ladder.posy&&moveValues.newy<=ladder.posy+ladder.height)&&(collision.ladder=!0,moveEntity&&(entity.moveValues.y=1))}collision.ladder?entity.touchedLadder=!0:entity.touchedLadder=!1;break;case"traps":if(checkArray=objects.traps,length=checkArray.length,length<=0)break;for(let i=0;i<length;i++){const trap=checkArray[i];if(!trap)continue;const moveValues=returnMoveValues(entity);(moveValues.newx+entity.width>trap.posx&&moveValues.newx<trap.posx+trap.width&&entity.posy+entity.height>trap.posy&&entity.posy<trap.posy+trap.height||entity.posx+entity.width>trap.posx&&entity.posx<trap.currentPosx+trap.width&&moveValues.newy+entity.height>=trap.posy&&moveValues.newy<=trap.posy+trap.height)&&(scoreUpdate(-1e3),editorMode||respawn(),playSound("death"))}break;case"tokens":if(checkArray=objects.tokens,length=checkArray.length,length<=0)break;for(let i=0;i<length;i++){const token=checkArray[i];if(!token)continue;const moveValues=returnMoveValues(entity);if(moveValues.newx+entity.width>token.posx&&moveValues.newx<token.posx+token.width&&entity.posy+entity.height>token.posy&&entity.posy<token.posy+token.height||entity.posx+entity.width>token.posx&&entity.posx<token.currentPosx+token.width&&moveValues.newy+entity.height>=token.posy&&moveValues.newy<=token.posy+token.height)switch(entity.mainType){case"nextStageToken":console.log("next stage");break;default:scoreUpdate(1e3),editorMode||objects.removeDict(token),playSound("pickUp")}}break;case"stairs":if(checkArray=objects.stairs,length=checkArray.length,objects.stairs.length<=0)break;for(let i=0;i<length;i++){let stair=checkArray[i];if(!stair)continue;const moveValues=returnMoveValues(entity);if(moveValues.newx+entity.width/2>stair.posx&&moveValues.newx<stair.posx+stair.width&&entity.posy+entity.height>stair.posy&&entity.posy<stair.posy+stair.height&&(collision.left=!0,collision.stairLeft=!0),moveValues.newx+entity.width>stair.posx&&moveValues.newx+entity.width/2<stair.posx+stair.width&&entity.posy+entity.height>stair.posy&&entity.posy<stair.posy+stair.height&&(collision.right=!0,collision.stairRight=!0),entity.posx+entity.width+20>stair.posx&&entity.posx-20<stair.posx+stair.width&&moveValues.newy+entity.height+20>=stair.posy&&moveValues.newy+entity.height/2<=stair.posy+stair.height&&(collision.top=!0),(collision.right||collision.left&&!collision.top)&&(collision.stairMove=!0),moveEntity&&collision.left&&entity.touchedGround&&!collision.top){entity.moveValues.y=.5,wallJumpAllowed=!1,wallJumpTimer&&clearTimeout(wallJumpTimer);break}if(moveEntity&&collision.right&&entity.touchedGround&&!collision.top){entity.moveValues.y=.5,wallJumpAllowed=!1,wallJumpTimer&&clearTimeout(wallJumpTimer);break}}break;case"solids":checkArray=objects.solids,length=checkArray.length;let tempScroll={x:0,y:0};if(length<=0)break;for(let i=0;i<length;i++){const solid=checkArray[i];if(!solid)continue;let moveValues=returnMoveValues(entity);if(moveValues.newx+entity.width/2>solid.posx&&moveValues.newx<solid.posx+solid.width&&entity.posy+entity.height-3>solid.posy&&entity.posy+3<solid.posy+solid.height&&("stopWall"==solid.mainType&&(collision.stopWall=!0),"borderWallLeft"==solid.mainType&&(collision.borderLeft=!0),entity.posx=solid.posx+solid.width+-1*moveValues.totMovX,collision.left=!0),moveValues.newx+entity.width>solid.posx&&moveValues.newx+entity.width/2<solid.posx+solid.width&&entity.posy+entity.height-3>solid.posy&&entity.posy+3<solid.posy+solid.height&&("stopWall"==solid.mainType&&(collision.stopWall=!0),"borderWallRight"==solid.mainType&&(collision.borderRight=!0),entity.posx=solid.posx-entity.width+-1*moveValues.totMovX,collision.right=!0),entity.posx+entity.width-3>solid.posx&&entity.posx+3<solid.posx+solid.width&&moveValues.newy+entity.height/2>=solid.posy&&moveValues.newy<=solid.posy+solid.height&&("stopWall"==solid.mainType&&(collision.stopWall=!0),"borderWallBottom"==solid.mainType?collision.borderBottom=!0:entity==objects.player&&moveEntity&&(entity.touchedGround=!0),moveEntity&&(entity.posy=solid.posy+solid.height+moveValues.totMovY*(collision.borderBottom?-1.1:-1)),collision.bottom=!0),entity.posx+entity.width-3>solid.posx&&entity.posx+3<solid.posx+solid.width&&moveValues.newy+entity.height>=solid.posy&&moveValues.newy+entity.height/2<=solid.posy+solid.height&&("stopWall"==solid.mainType&&(collision.stopWall=!0),"borderWallTop"==solid.mainType&&(collision.borderTop=!0),moveEntity&&(entity.posy=solid.posy-entity.height+moveValues.totMovY*(collision.borderTop?-1.1:-1)),collision.top=!0),entity==objects.player&&moveEntity&&entity.posx+entity.width-3>solid.posx&&entity.posx+3<solid.posx+solid.width&&moveValues.newy+entity.initHeight>=solid.posy&&moveValues.newy+entity.initHeight/2<=solid.posy+solid.height){if("borderWallTop"==solid.mainType){collision.borderTop=!0,tempScroll.y-=moveValues.totMovY>0?moveValues.totMovY:0,entity.touchedLadder||(entity.posy=entity.posy+tempScroll.y);continue}entity.crouched=!0}}if(moveEntity&&"player"==entity.mainType){const moveValues=returnMoveValues(entity);scrollOffsetAdjustment.x=scrollOffsetAdjustment.y=0,(collision.borderLeft||collision.borderRight)&&(scrollOffsetAdjustment.x+=-1.1*moveValues.totMovX+tempScroll.x),(collision.borderTop||collision.borderBottom)&&(scrollOffsetAdjustment.y+=-1.1*moveValues.totMovY+tempScroll.y),scrollOffsetTotal.x+=scrollOffsetAdjustment.x,scrollOffsetTotal.y+=scrollOffsetAdjustment.y}collision.border=collision.borderLeft||collision.borderRight||collision.borderTop||collision.borderBottom}return collision};function makeDefaultEntities(justBorders=!1){const borderThickness=config.borderThickness,borderColor=debugMode?"rgba(255, 255, 255, 0.5)":"rgba(0, 0, 0, 0)",defaultEntities=[justBorders?null:{width:canvas.width,height:canvas.height,initPosx:0,initPosy:0,styles:["img","backgroundImg","idle"],types:["backgroundImg","background","frozen"]},justBorders?null:{width:1e6,height:600,initPosx:-600,initPosy:-560,styles:["draw","#92d03b"],types:["solid"]},justBorders?null:{width:600,height:1e4,initPosx:-500,initPosy:0,styles:["draw","#92d03b"],types:["solid"]},{width:canvas.width,height:borderThickness,initPosx:0,initPosy:0,styles:["draw",borderColor],types:["borderWallBottom","border","solid","frozen"]},{width:canvas.width,height:borderThickness,initPosx:0,initPosy:canvas.height-borderThickness,styles:["draw",borderColor],types:["borderWallTop","border","solid","frozen"]},{width:borderThickness-60,height:canvas.height,initPosx:0,initPosy:0,styles:["draw",borderColor],types:["borderWallLeft","border","solid","frozen"]},{width:borderThickness+700,height:canvas.height,initPosx:canvas.width-borderThickness-700,initPosy:0,styles:["draw",borderColor],types:["borderWallRight","border","solid","frozen"]}];objects.player||(objects.player=new entity(100,200,310,310,["img","player","idleR"],["player"])),objects.origin||(objects.origin=new entity(10,10,0,0,["draw",debugMode?"#1370df":"rgba(0, 0, 0, 0)"],void 0)),objects.bounds||(console.log("bounds made"),objects.bounds=new entity(canvas.width-borderThickness-700-borderThickness+60,canvas.height-borderThickness-borderThickness,borderThickness-60,borderThickness,["draw",borderColor],["bounds","frozen"])),loadMap(null,!1,defaultEntities)}function loadMap(mapID="stage2",clearMap=!0,mapArray=null){if(ctx.fillRect(0,0,canvas.width,canvas.height,"black"),clearMap){scrollOffsetTotal={x:0,y:0};let keyList=Object.keys(objects);keyList.removeArray("player"),keyList.removeArray("origin"),keyList.removeArray("bounds"),keyList.removeArray("backgroundImg");for(let i=0;i<keyList.length;i++)objects[keyList[i]]=[];objects.player=null,objects.origin=null}let mapObjects=mapArray||map[mapID],length=mapArray?mapArray.length:Object.keys(mapObjects).length,loadMapPrecision=1;for(let i=0;i<length;i++)ctx.fillRect(0,0,canvas.width,canvas.height,"black"),mapObjects[i]&&0!=mapObjects[i].width&&0!=mapObjects[i].height&&new entity((mapObjects[i].width>1?mapObjects[i].width:1).round(1),(mapObjects[i].height>1?mapObjects[i].height:1).round(1),mapObjects[i].initPosx.round(1),mapObjects[i].initPosy.round(1),mapObjects[i].styles,mapObjects[i].types);try{"makeDefaultEntities"!=loadMap.caller.name&&makeDefaultEntities()}catch(TypeError){throw makeDefaultEntities(),"TypeError: loadMap.caller is null, recursion check failed.\n\nMaking default entities."}console.log("Map loaded.")}function playSound(sound){soundManager.play(sound)}const update=delta=>{let player;if(player){player=objects.player;try{if(lastPos=[player.posx,player.posy],lastMove=[player.moveValues.x,player.moveValues.y],playerMovementGravity(delta),playerMovementCheck&&(Math.abs(lastPos[0]-player.posx)>config.playerMaxSpeedError||Math.abs(lastPos[1]-player.posy)>config.playerMaxSpeedError)){console.log("Player moved too fast"),player.posx=lastPos[0],player.posy=lastPos[1];let collision=detectCollision(player,"solids",!1);collision.bottom&&(player.posy=lastPos[1]+4),collision.top&&(player.posy=lastPos[1]-4)}playerMovementCheck=!0}catch(TypeError){}}},draw=()=>{totalFrames++;for(let i=0;i<objects.traps.length;i++)objects.traps[i].totalTimePassed+=1/config.fps;animateRunner(),frameUpdate(),objects.player.draw()},end=()=>{ctx.clearRect(0,0,canvas.width,canvas.height)};window.startUp=()=>{loadMap(),MainLoop.setUpdate(update).setDraw(draw).setEnd(end),setTimeout(()=>{console.log("Starting main loop"),MainLoop.start()},1e3)};