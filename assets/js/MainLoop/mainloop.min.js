!function(root){var simulationTimestep=1e3/60,frameDelta=0,lastFrameTimeMs=0,fps=60,fpsAlpha=.9,fpsUpdateInterval=1e3,lastFpsUpdate=0,framesSinceLastFpsUpdate=0,numUpdateSteps=0,minFrameDelay=0,running=!1,started=!1,panic=!1,windowOrRoot="object"==typeof window?window:root,requestAnimationFrame=windowOrRoot.requestAnimationFrame||(lastTimestamp=Date.now(),function(callback){return now=Date.now(),timeout=Math.max(0,simulationTimestep-(now-lastTimestamp)),lastTimestamp=now+timeout,setTimeout((function(){callback(now+timeout)}),timeout)}),cancelAnimationFrame=windowOrRoot.cancelAnimationFrame||clearTimeout,NOOP=function(){},begin=NOOP,update=NOOP,draw=NOOP,end=NOOP,rafHandle,lastTimestamp,now,timeout;function animate(timestamp){if(rafHandle=requestAnimationFrame(animate),!(timestamp<lastFrameTimeMs+minFrameDelay)){for(frameDelta+=timestamp-lastFrameTimeMs,lastFrameTimeMs=timestamp,begin(timestamp,frameDelta),timestamp>lastFpsUpdate+1e3&&(fps=.9*framesSinceLastFpsUpdate*1e3/(timestamp-lastFpsUpdate)+(1-.9)*fps,lastFpsUpdate=timestamp,framesSinceLastFpsUpdate=0),framesSinceLastFpsUpdate++,numUpdateSteps=0;frameDelta>=simulationTimestep;)if(update(simulationTimestep),frameDelta-=simulationTimestep,++numUpdateSteps>=240){panic=!0;break}draw(frameDelta/simulationTimestep),end(fps,panic),panic=!1}}root.MainLoop={getSimulationTimestep:function(){return simulationTimestep},setSimulationTimestep:function(timestep){return simulationTimestep=timestep,this},getFPS:function(){return fps},getMaxAllowedFPS:function(){return 1e3/minFrameDelay},setMaxAllowedFPS:function(fps){return void 0===fps&&(fps=1/0),0===fps?this.stop():minFrameDelay=1e3/fps,this},resetFrameDelta:function(){var oldFrameDelta=frameDelta;return frameDelta=0,oldFrameDelta},setBegin:function(fun){return begin=fun||begin,this},setUpdate:function(fun){return update=fun||update,this},setDraw:function(fun){return draw=fun||draw,this},setEnd:function(fun){return end=fun||end,this},start:function(){return started||(started=!0,rafHandle=requestAnimationFrame((function(timestamp){draw(1),running=!0,lastFrameTimeMs=timestamp,lastFpsUpdate=timestamp,framesSinceLastFpsUpdate=0,rafHandle=requestAnimationFrame(animate)}))),this},stop:function(){return running=!1,started=!1,cancelAnimationFrame(rafHandle),this},isRunning:function(){return running}},"function"==typeof define&&define.amd?define(root.MainLoop):"object"==typeof module&&null!==module&&"object"==typeof module.exports&&(module.exports=root.MainLoop)}(this);